---
title: "Final LTDS Report"
date: "`r Sys.Date()`"
output: pdf_document
params:
  effort: "NA"
  nburr: "NA"
  burr.w.mn: "NA"
  burr.w.min: "NA"
  burr.w.max: "NA"
  comm.comm: "NA"
  occ: "NA"
  unocc: "NA"
  unk: "NA"
  site.name: "NA"
  surv.date: "NA"
  tort.dens: "NA"
  tort.dens.lo: "NA"
  tort.dens.hi: "NA"
  tort.pop: "NA"
  tort.pop.lo: "NA"
  tort.pop.hi: "NA"

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}

library(raster)
library(rgeos)
library(rgdal)
library(dplyr)
library(readr)
library(nimble)
library(terra)
library(ggplot2)
library(gt)
```
# LTDS Summary - `r params$site.name`

Test report for LTDSMethod package.

### Overview

We walked a total of __`r format(params$effort, scientific=FALSE)`__ m during our full LTDS survey, where we found a total of __`r params$nburr`__ burrows. We calculated a density of __`r params$tort.dens`__ tortoises/acre (range = __`r params$tort.dens.lo`__ - __`r params$tort.dens.hi`__ tortoises/acre), resulting in approximately __`r params$tort.pop`__ tortoises (range = __`r params$tort.pop.lo`__ - __`r params$tort.pop.hi`__) at the recipient site. We calculated a mean burrow width of __`r params$burr.w.mn`__ mm (range = __`r params$burr.w.min`__ - __`r params$burr.w.max`__).

```{r burr.w.hist, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
ltds_data <- read_csv("./LTDS_example_data.csv")
  #Create frequency plot of burrow widths
  wh.plot <- ggplot(data = ltds_data, aes(x = Burrow_width)) +
    #geom_density(fill = "grey") +
    geom_histogram(aes(fill = ..density..), color = "black",
                   binwidth = 20, alpha = 0.8) +
    scale_fill_viridis_c(option = "viridis", begin = 0.3, end = 0.6) +
    ylab("Frequency") +
    xlab("Burrow width") +
    ggtitle("Distribution of burrow widths") +
    theme_classic() +
    theme(legend.position = "none")

  wh.plot
```



```{r burr.w.dens, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
  #Create density plot of burrow widths
  wd.plot <- ggplot(data = ltds_data, aes(x = Burrow_width)) +
    geom_density(aes(y = ..density..), fill = "grey") +
    #geom_histogram(aes(fill = ..density..), color = "black",
    #               binwidth = 20, alpha = 0.8) +
    scale_fill_viridis_c(option = "viridis", begin = 0.3, end = 0.6) +
    ylab("Density") +
    xlab("Burrow width") +
    ggtitle("Distribution of burrow widths") +
    theme_classic() +
    theme(legend.position = "none")

  wd.plot
```

We found __`r params$occ`__ __occupied__ burrows, __`r params$unocc`__ __unoccupied__ burrows, and __`r params$unk`__ __unknowns__.

```{r occu.figure, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
#Plotting burrow types
o.plot <- ggplot(data = ltds_data, aes(x = Occupied)) +
  #geom_density(aes(y = ..density..), fill = "grey") +
  geom_histogram(aes(fill = Occupied), color = "black",
                 alpha = 0.8, stat = "count") +
  scale_fill_viridis_d(option = "viridis", begin = 0.3, end = 0.6) +
  scale_x_discrete(limits = c("No","Yes","Unknown")) +
  ylab("Frequency") +
  xlab("Burrow occupied?") +
  ggtitle("Burrow occupancy status") +
  theme_classic() +
  theme(legend.position = "none")

o.plot
```


```{r det.dist.hist, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
#Create detection distance plot
dh.plot <- ggplot(data = ltds_data, aes(x = Distance)) +
  #geom_density(fill = "grey") +
  geom_histogram(aes(fill = ..density..), color = "black",
                 binwidth = 1, alpha = 0.8) +
  scale_fill_viridis_c(option = "viridis", begin = 0.3, end = 0.6) +
  ylab("Frequency") +
  xlab("Distance") +
  ggtitle("Detection distances") +
  theme_classic() +
  theme(legend.position = "none")

dh.plot
```

```{r det.dist.dens, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
#Create detection distance plot
dd.plot <- ggplot(data = ltds_data, aes(x = Distance)) +
  geom_density(aes(y = ..density..), fill = "grey") +
  #geom_histogram(aes(fill = ..density..), color = "black",
  #               binwidth = 20, alpha = 0.8) +
  scale_fill_viridis_c(option = "viridis", begin = 0.3, end = 0.6) +
  ylab("Density") +
  xlab("Detection distance") +
  ggtitle("Detection distances") +
  theme_classic() +
  theme(legend.position = "none")

dd.plot
```

```{r mort.plot, echo=FALSE, warning=FALSE, message=FALSE, verbose = FALSE, error=FALSE}
#site <- raster("./site_6_new.tif")
site.2 <- readOGR("./site_6_new_poly.shp", verbose = FALSE)
mort_data <- read_csv("./Other_observation_form_v2.csv")
#Create frequency plot of burrow widths
lines <- readOGR("./Transect_lines.shp", verbose = FALSE)
lines.2 <- readOGR("./Add_transect_lines.shp", verbose = FALSE)
ggplot() +
  geom_polygon(data = site.2, aes(x = long, y = lat, group = group),
               fill = "grey") +
  geom_line(data = lines, aes(x = long, y = lat, group = group)) +
  geom_line(data = lines.2, aes(x = long, y = lat, group = group)) +
  geom_point(data = mort_data, aes(x = Easting, y = Northing, pch = Species),
             size = 3, color = "red") +
  #scale_fill_viridis_c(option = "mako", begin = 0.3, end = 0.8) +
  #scale_color_viridis_d(option = "mako", begin = 0.3, end = 0.8) +
  xlab("Easting") +
  ylab("Northing") +
  theme_classic() +
  theme() +
  guides(fill = "none")

```

The most common commensal species discovered in burrows during scoping was the __`r params$comm.comm`__. A breakdown of the commensal species detection can be seen in the following table and figure:

```{r commensals.table, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
#List of commensals
mort_data <- read_csv("./Other_observation_form_v2.csv")
#Filter out gopher tortoise mortalities
comm.data <- mort_data %>%
  filter(Species != "Gopher tortoise")
comm.sp <- unique(comm.data$Species)

#Create numbering dataframe for reordering ggplot
#Make list for new val column
com.list <- vector(mode = "list", length = length(comm.sp))
for (i in 1:length(comm.sp)) {
  new.sum <- sum(mort_data$Species == comm.sp[i])
  com.list[i] <- new.sum
}
#Turn list into string
val.data <- do.call(rbind.data.frame, com.list)
colnames(val.data) <- c("val")
#Join new variables
comm.data <- cbind(comm.sp, val.data)
colnames(comm.data) <- c("Species", "No.found")
new.data <- comm.data[order(comm.data$No.found),]

#Create table
comm.data.gt <- new.data %>%
  gt() %>%
  tab_header("Commensal species discovered")

comm.data.gt
```

```{r commensals.fig, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
mort_data <- read_csv("./Other_observation_form_v2.csv")
comm.data <- mort_data %>%
  filter(Species != "Gopher tortoise")
comm.sp <- unique(comm.data$Species)

#Create numbering dataframe for reordering ggplot
#Make list for new val column
com.list <- vector(mode = "list", length = length(comm.sp))
for (i in 1:length(comm.sp)) {
  new.sum <- sum(mort_data$Species == comm.sp[i])
  com.list[i] <- new.sum
}
#Turn list into string
val.data <- do.call(rbind.data.frame, com.list)
colnames(val.data) <- c("val")
#Join new variables
comm.data <- cbind(comm.sp, val.data)

#Plotting number of commensals
c.plot <- ggplot(data = comm.data,) +
  geom_col(aes(x = reorder(comm.sp, +val), y = val, fill = val), color = "black") +
  scale_fill_viridis_c(option = "viridis", begin = 0.3, end = 0.6) +
  scale_x_discrete(guide = guide_axis(n.dodge=2)) +
  ylab("Frequency") +
  xlab("Commensal species") +
  ggtitle("Number of commensal species discovered") +
  theme_classic() +
  theme(legend.position = "none")

c.plot
```

```{r mortality.table, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, verbose = FALSE}
#List of commensals
mort_data <- read_csv("./Other_observation_form_v2.csv")
#Filter out gopher tortoise mortalities
tort.mort <- mort_data %>%
  filter(Species == "Gopher tortoise")
#comm.sp <- unique(comm.data$Species)

#Create table
tort.mort.gt <- tort.mort %>%
  gt() %>%
  tab_header("Gopher tortoise mortalities")

tort.mort.gt

site.2 <- readOGR("./site_6_new_poly.shp", verbose = FALSE)
lines <- readOGR("./Transect_lines.shp", verbose = FALSE)
lines.2 <- readOGR("./Add_transect_lines.shp", verbose = FALSE)
ggplot() +
  geom_polygon(data = site.2, aes(x = long, y = lat, group = group),
               fill = "grey") +
  geom_line(data = lines, aes(x = long, y = lat, group = group)) +
  geom_line(data = lines.2, aes(x = long, y = lat, group = group)) +
  geom_point(data = tort.mort, aes(x = Easting, y = Northing),
             pch=-as.hexmode("2620"), size = 10, color = "red") +
  #scale_fill_viridis_c(option = "mako", begin = 0.3, end = 0.8) +
  #scale_color_viridis_d(option = "mako", begin = 0.3, end = 0.8) +
  xlab("Easting") +
  ylab("Northing") +
  theme_classic() +
  theme(legend.position = "bottom") +
  guides(fill = "none")

```

End of report. 
